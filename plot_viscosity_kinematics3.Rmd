---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r setup}
library(tidyverse)
library(lubridate)
library(ggdist)
library(ggpubr)
library(rstatix)
library(performance)
library(lme4)
library(lmerTest)
library(report)
library(emmeans)
library(broom)
library(car)
library(patchwork)
library(here)
library(gt)
```

```{r}
source(here('process_midlines.R'))
source(here('hdf5dataset.R'))
```

# Load the data

Load in the processed kinematics data and update some of the variable names.  This includes frame-by-frame data for the entire body.

```{r}
kinematicsdata_all <- read_hdf5_old(here('midlines_all_kinematics.h5')) %>%
  mutate(date = as_date(date)) %>%
  mutate(wavespeed.mms = (snextseg - s)/(tpnextseg - tp)) %>%
  filter(!is.na(viscosity.cP)) %>%
  mutate(indiv = factor(indiv),
         viscosity.cP = factor(viscosity.cP),
         trial = interaction(indiv, trial, sep='-')) %>%
  rename(freq.hz = freq,
         wavelength.mm = wavelength,
         amp.mm = amp,
         speed.mms = swimvels)
```

```{r}
rho <- 1000   # kg/m^3
```

Now take means over half tailbeat cycles and over the body.
```{r}
kinematicsdata <-
  kinematicsdata_all %>%
  filter(!is.na(cycle)) %>%
  arrange(indiv, trial, frame, bodyparts) %>%
  mutate(amp.mm = abs(amp.mm)) %>%
  # take means across the body in each frame
  group_by(indiv, len.mm, trial, viscosity.cP, frame) %>%
  # ignore wavespeed estimates for the anterior body
  mutate(wavespeed.mms = if_else(bodyparts %in% c('15','16','17','18','19','20'), wavespeed.mms, NA_real_)) %>%
  summarize(across(c(speed.mms, freq.hz, wavespeed.mms, wavelength.mm), ~ mean(.x, na.rm = TRUE)),
         across(c(cycle, t), ~ last(na.omit(.x))),
         amp.body.mm = mean(amp.mm, na.rm = TRUE),
         amp.tail.mm = last(na.omit(amp.mm)),
         amp.head.mm = first(na.omit(amp.mm)),
         curve.post = mean(if_else(between(s/len.mm, 0.75, 0.95), abs(curve), NA_real_), na.rm = TRUE)) %>%
  # then take means across each cycle
  group_by(indiv, len.mm, trial, viscosity.cP, cycle) %>%
  summarize(across(c(speed.mms, freq.hz, wavespeed.mms, wavelength.mm, 
                     amp.body.mm, amp.tail.mm, amp.head.mm, curve.post), ~ mean(.x, na.rm = TRUE)),
            tcycle.s = first(na.omit(t))) %>%
  ungroup()
```

Normalize by length
```{r}
kinematicsdata <-
  kinematicsdata %>%
  mutate(speed.Ls = speed.mms / len.mm,
         amp.L = amp.body.mm / len.mm,
         wavespeed.Ls = wavespeed.mms / len.mm,
         wavelength.L = wavelength.mm / len.mm,
         amp.head.L = amp.head.mm / len.mm,
         amp.tail.L = amp.tail.mm / len.mm)
```

Add nondimensional parameters
```{r}
kinematicsdata <-
  kinematicsdata %>%
  mutate(St = 2 * freq.hz * amp.tail.mm / speed.mms,
         stridelength = speed.Ls / freq.hz,
         slip = speed.Ls / wavespeed.Ls)
```

## Initial checks on the data

Plot all the swimming speeds, just to check.
```{r}
kinematicsdata %>%
  ggplot(aes(x = tcycle.s, y = speed.Ls, color = indiv, group = trial)) +
  geom_path() +
  facet_grid(viscosity.cP ~ ., scales = 'free')
```
### Swimming speed vs frequency

Should be nice and linear, but maybe a different slope with different viscosity.
```{r}
kinematicsdata %>%
  ggplot(aes(x = freq.hz, speed.Ls, color = indiv)) +
  geom_point() +
  facet_grid(viscosity.cP ~ ., scales = 'free') +
  xlim(c(0, 10))
```



```{r}
kinematicsdata <-
  kinematicsdata |> 
  filter(!(trial %in% c('5-2', '7-40', '8-1', '8-42')))
```

### Stride length vs speed

Should not depend strongly on speed.
```{r}
kinematicsdata %>%
  ggplot(aes(x = speed.Ls, y = stridelength)) +
  geom_point(aes(color = indiv)) +
  facet_grid(viscosity.cP ~ indiv)
```

### Stride length and slip

Plot frequency vs speed, and the ratio, which is stride length. And wavespeed vs speed, and the ratio, which is slip. Both stride length and slip shouldn't depend too much on swimming speed.
```{r}
p1 <- kinematicsdata %>%
  filter(wavespeed.Ls > 0 & wavespeed.Ls < 7,
         freq.hz > 0 & freq.hz < 10) %>%
  ggplot(aes(x = speed.Ls, y = freq.hz, color = viscosity.cP)) +
  geom_point()

p2 <- kinematicsdata %>%
  filter(wavespeed.Ls > 0 & wavespeed.Ls < 7,
         freq.hz > 0 & freq.hz < 10) %>%
  ggplot(aes(x = speed.Ls, y = stridelength, color = viscosity.cP)) +
  geom_point()

p3 <- kinematicsdata %>%
  filter(wavespeed.Ls > 0 & wavespeed.Ls < 7,
         freq.hz > 0 & freq.hz < 10) %>%
  ggplot(aes(x = speed.Ls, y = wavespeed.Ls, color = viscosity.cP)) +
  geom_point()

p4 <- kinematicsdata %>%
  filter(wavespeed.Ls > 0 & wavespeed.Ls < 7,
         freq.hz > 0 & freq.hz < 10) %>%
  ggplot(aes(x = speed.Ls, y = slip, color = viscosity.cP)) +
  geom_point()

p1 + p2 + p3 + p4 + plot_layout(guides = 'collect')
```
## Filter out some outliers

```{r}
kinematicsdata %>%
  filter(indiv == '8' & speed.Ls > 4)
```

```{r}
kinematicsdata %>%
  filter(indiv == '5' & stridelength > 0.5 & viscosity.cP == 20)
```

```{r}
kinematicsdata %>%
  filter(stridelength > 1)
```

```{r}
outliertrials <- c('8-1', '5-2', '7-40', '8-42')
```

## Get means in each trial

```{r}
kinematicsdata.bytrial <-
  kinematicsdata %>%
  filter(!(trial %in% outliertrials),
         wavespeed.Ls > 0 & wavespeed.Ls < 7, 
         freq.hz > 0 & freq.hz < 10) %>%
  group_by(indiv, len.mm, viscosity.cP, trial) %>%
  summarize(across(c(speed.Ls, freq.hz, amp.L, amp.head.L, amp.tail.L, wavelength.L, wavespeed.Ls, curve.post,
                     slip, stridelength, St),
                   ~ mean(., na.rm = TRUE)),
            dur.s = max(tcycle.s, na.rm = TRUE) - min(tcycle.s, na.rm = TRUE),
            nbeats = sum(!is.na(cycle))/2) %>%
  ungroup()

head(kinematicsdata.bytrial)
```

```{r}
write_hdf5(kinematicsdata.bytrial, 'kinematicsdatabytrial.h5')
```

### Add in Luna's wavelengths

```{r}
coddata <- read_csv('Data/coddata.csv') %>%
  mutate(indiv = factor(indiv),
         viscosity = factor(viscosity)) %>%
  select(-`...1`)
```
```{r}
coddata <- 
  coddata %>%
  filter(mode == 1 & point == 20) %>%
  select(indiv, trial, wavelength, wavelength2, windingnum, traveling) %>%
  mutate(trial = paste(indiv, trial, sep='-')) %>%
  rename(wavelength3 = wavelength2,
         wavelength2 = wavelength)
```

```{r}
kinematicsdata.bytrial <-
  left_join(kinematicsdata.bytrial, coddata,
          by = c("indiv", "trial")) %>%
  mutate(wavelength2.L = wavelength2/len.mm,
         wavelength4.L = wavelength3/len.mm,
         wavelength3.mm = len.mm / windingnum,
         wavelength3.L = 1.0 / windingnum) %>%
  select(-wavelength2)
```

Update the viscosity measurement. 10cP was actually 6cP.
```{r}
kinematicsdata.bytrial <-
  kinematicsdata.bytrial %>%
  mutate(viscosity = viscosity.cP,
         viscosity.cP = case_when(viscosity == '1'  ~  1,
                                  viscosity == '10'  ~  10,
                                  viscosity == '20'  ~  20))
```

### Add in the tail velocity and additional amplitude calculation

```{r}
tailvelbycycle <- read_csv('tailveldata.csv')
head(tailvelbycycle)
```

```{r}
kinematicsdata.bytrial <-
  tailvelbycycle %>%
  mutate(trial = paste(indiv, trial, sep='-'),
         indiv = factor(indiv)) %>%
  group_by(indiv, trial) %>%
  summarize(across(c(amp.mm), ~ mean(., na.rm = TRUE))) %>%
  right_join(kinematicsdata.bytrial, by = c("indiv", "trial")) %>%
  mutate(amp.L = amp.mm / len.mm)

head(kinematicsdata.bytrial)
```

```{r}
kinematicsdata.bytrial %>%
  ggplot(aes(x = amp.tail.L, y = amp.L, color = viscosity.cP)) +
  geom_point() +
  geom_abline(slope = 1)
```

# CFD data

```{r}
simkinematics <- read_hdf5(here('simkinematics.h5'))
```

```{r}
simkinematics <-
  simkinematics |> 
  mutate(viscosity = fct_recode(viscosity, '1' = '1x', '10' = '10x', '20' = '20x'))
```

```{r}
simkinematics <-
  simkinematics |> 
  filter(issteady == 1) |> 
  group_by(viscosity, trial, bodyparts, cycle) |> 
  summarize(curve = max(abs(curve), na.rm = TRUE),
            amp = max(abs(exc), na.rm = TRUE),
            s = mean(s, na.rm = TRUE),
            swimvel = mean(swimvels, na.rm = TRUE),
            wavelength = mean(wavelength, na.rm = TRUE)) |> 
  summarize(across(c(curve, amp, swimvel, wavelength, s), ~ mean(.x, na.rm = TRUE)))
```

```{r}
simkinematics.byvisc <-
  simkinematics |> 
  mutate(len.mm = 4*pi*10,
         amp.L = amp / len.mm,
         swimvel.Ls = swimvel / len.mm,
         wavelength.L = wavelength / len.mm) |> 
  group_by(viscosity, trial, len.mm) |> 
  summarize(amp.L = mean(amp.L, na.rm = TRUE),
            swimvel.Ls = last(na.omit(swimvel.Ls)),
            wavelength.L = last(na.omit(wavelength.L)),
            curve.post = mean(if_else(between(s/len.mm, 0.75, 0.95), curve, NA_real_), na.rm = TRUE))
```

# Main kinematics plots

```{r}
binwidth <- 0.02
shapes <- c(15,16,17,25,23)
```

```{r}
kinematicsdata.bytrial <-
  kinematicsdata.bytrial |> 
  mutate(viscosity = fct_expand(viscosity, '10'),
         viscosity = fct_relevel(viscosity, c('1','6','10','20')),
         viscosity = fct_recode(viscosity, '10' = '6'))
```

## Speed vs viscosity

```{r}
speed_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = speed.Ls)) +
  geom_dots(aes(color = indiv, shape = indiv, fill = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  scale_x_discrete(drop = FALSE) +
  labs(y = 'Speed (L/s)', x = 'Viscosity (cP)') +
  expand_limits(y = 0) +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line()) +
  geom_point(data = simkinematics.byvisc,
             aes(x = viscosity, y = swimvel.Ls), size = 4)

speed_plot
```

```{r}
kinematicsdata.bytrial |> 
  group_by(viscosity) |> 
  summarize(across(c(speed.Ls), list(mn=mean, sd=sd)))
```

## Overall mean amplitude vs viscosity

```{r}
amp_tail_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = amp.L)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  scale_x_discrete(drop = FALSE) +
  labs(y = 'Mean body amplitude (L)', x = 'Viscosity (cP)') +
  theme_bw() +
  expand_limits(y = 0) +
  theme(panel.border = element_blank(), axis.line = element_line()) +
  geom_point(data = simkinematics.byvisc, 
               aes(x = viscosity, y = amp.L), size = 4)

amp_tail_plot
```



### Head amplitude relative to the tail

This may not make it in to the paper as a main figure.
```{r}
rel_amp_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = amp.head.L / amp.tail.L)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Head amplitude relative to tail', x = 'Viscosity (cP)') +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())

rel_amp_plot
```
## Frequency vs viscosity

```{r}
freq_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = freq.hz)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Frequency (Hz)', x = 'Viscosity (cP)') +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())

freq_plot
```

## Wavelength vs viscosity

```{r}
kinematicsdata.bytrial |> 
  group_by(indiv, viscosity) |> 
  summarize(across(c(len.mm, 
                     wavelength.L, wavelength2.L, wavelength3.mm, wavelength3.L, wavelength4.L),
                   ~ mean(., na.rm = TRUE)))

```

```{r}
wavelen_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = wavelength3.L)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  scale_x_discrete(drop = FALSE) +
  labs(y = 'Wavelength (L)', x = 'Viscosity (cP)') +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line()) +
  geom_point(data = simkinematics.byvisc, aes(x = viscosity, y = wavelength.L), size = 4)

wavelen_plot
```

```{r}
curve_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = curve.post)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  scale_x_discrete(drop = FALSE) +
  labs(x = 'Viscosity (cP)', y = 'Posterior body curvature (L-1)') +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line()) +
  geom_point(data = simkinematics.byvisc, aes(x = viscosity, y = curve.post), size = 3)

curve_plot
```


# Statistical tests

Rearrange the data table in an even longer format so that we can run all of the tests all at once.
```{r}
kinematicsdata.long <-
  kinematicsdata.bytrial %>%
  mutate(amp.rel = amp.head.L / amp.tail.L,
         Re_body = rho * speed.Ls * (len.mm/1000)^2 / (viscosity.cP * 1e-3)) %>%
  select(indiv, viscosity, trial, speed.Ls, amp.rel, amp.L, amp.tail.L, freq.hz, wavelength3.L, wavespeed.Ls, slip, stridelength, St, dur.s, nbeats, Re_body, traveling, curve.post) %>%
  pivot_longer(cols = c(speed.Ls, amp.rel, amp.tail.L, amp.L, freq.hz, wavelength3.L, wavespeed.Ls, slip, stridelength, St, dur.s, nbeats, Re_body, traveling, curve.post), names_to = "param")
```

Plot key parameters just to check.
```{r}
kinematicsdata.long %>%
  filter(param %in% c('speed.Ls', 'amp.L', 'freq.hz', 'wavelength3.L', 'wavespeed.Ls', 'curve.post')) %>%
  ggplot(aes(x = viscosity, y = value)) +
  geom_dots(layout = 'swarm', side='both',
            binwidth = unit(0.02, 'npc')) +
  facet_wrap(~ param, scales = 'free')
```

And the nondimensional parameters
```{r}
kinematicsdata.long %>%
  filter(param %in% c('stridelength', 'slip', 'St',  'traveling')) %>%
  ggplot(aes(x = viscosity, y = value)) +
  geom_dots(layout = 'swarm', side='both') +
#            binwidth = unit(0.02, 'npc')) +
  facet_wrap(~ param, scales = 'free')
```

Get overall means and standard deviations
```{r}
kinematicsdata.long %>%
  group_by(param, viscosity) %>%
  summarize(mn = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))
```

```{r}
kinematicsdata.long %>%
  filter(param %in% c('wavelength3.L', 'amp.tail.L')) %>%
  group_by(param, indiv, viscosity) %>%
  summarize(mn = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE)) %>%
  mutate(d = mn - first(mn)) %>%
  arrange(param, viscosity, indiv)
```

## Build the models

Make a nested data frame and run `lmer` to estimate a mixed model with viscosity as a fixed factor and individual as a random factor.

Note that I tried running a model with individual responses to viscosity as a random effect also (`value ~ viscosity + (1 + viscosity | indiv)`), but it was singular.
```{r}
kinematicsmodels <-
  kinematicsdata.long %>%
  group_by(param) %>%
  nest() %>%
  mutate(model = purrr::map(data, ~ lmer(value ~ viscosity + (1 | indiv),
                                         data = ., REML = TRUE, na.action = na.omit)),   # run the test
         anova = purrr::map(model, ~ tidy(Anova(., test = 'F'))),   # get the fixed effect p value
         pairs = purrr::map(model, ~ tidy(pairs(emmeans(., specs = ~viscosity)))))   # and the pairwise comparisons
```

Then unnest the data frame and pull out the overall significance and the p values for comparing each case to the control (viscosity = 1cP).
```{r}
kinematicsstats <-
  kinematicsmodels %>%
  unnest(anova) %>%
  select(-term) %>%
  rename(Fstat = statistic,
         Fdf1 = df,
         Fdf2 = Df.res,
         Fp = p.value) %>%
  select(-data, -model) %>%
  unnest(pairs) %>%
  separate(contrast, into = c("group1", "group2")) %>%
  mutate(across(c(group1, group2), ~ str_extract(., '\\d+'))) %>%
  mutate(p.format = p_format(adj.p.value, accuracy = 0.001)) %>%
  rename(p.adj = adj.p.value) %>%
  filter(group1 == 1) %>%
  # mutate(group1 = 'all') %>%
  add_significance('p.adj') %>%
  mutate(viscosity = group1)
  #select(-term, -null.value, -estimate, -std.error, -df, -statistic) %>%
  #pivot_wider(names_from = contrast, values_from = adj.p.value)

kinematicsstats
```



Also add in the group-wise marginal means.
```{r}
kinematicsmodelmeans <-
  kinematicsmodels %>%
  mutate(means = purrr::map(model, ~ tidy(emmeans(., specs = ~viscosity)))) %>%
         #effs = purrr::map(model, ~ tidy(eff_size(., specs)))) %>%
  select(param, means) %>%
  unnest(means)

kinematicsmodelmeans
```

```{r}
effect_sizes <-
  kinematicsmodels %>%
  mutate(effs = purrr::map(model, 
                           ~tidy(eff_size(emmeans(., specs = ~viscosity),
                                          sigma = sigma(.),
                                          edf = df.residual(.))))) %>%
  select(param, effs) %>%
  unnest(effs)
```

```{r}
effect_sizes
```

```{r}
statstable <-
  kinematicsstats %>%
  select(param, Fstat, Fdf1, Fdf2, Fp) %>%
  ungroup() %>%
  distinct(param, .keep_all = TRUE) %>%
  right_join(effect_sizes, by = 'param') %>%
  mutate(contrast = str_remove_all(contrast, 'viscosity')) %>%
  select(-c(term, null.value, std.error, df, statistic)) %>%
  rename(eff = estimate,
         p.cont = p.value) %>%
  add_significance('p.cont') %>%
  select(-p.cont) %>%
  filter(contrast != '10 - 20') %>%
  mutate(eff = -eff,
         contrast = case_when(contrast == '1 - 10'  ~  '10 - 1',
                              contrast == '1 - 20'  ~  '20 - 1')) %>%
  pivot_wider(names_from = contrast, values_from = c(eff, p.cont.signif)) %>%
  select(param, Fstat, Fdf1, Fdf2, Fp, 
         `eff_10 - 1`, `p.cont.signif_10 - 1`, `eff_20 - 1`, `p.cont.signif_20 - 1`) %>%
  filter(param %in% c('speed.Ls',
                      'amp.L',
                      'freq.hz',
                      'wavelength2.L',
                      'curve.post',
                      'wavespeed.Ls',
                      'stridelength',
                      'St',
                      'traveling')) %>%
  separate(param, into = c('param'), sep = '\\.', extra = 'drop') %>%
  mutate(param = case_when(param == 'speed'  ~   'Swimming speed',
                           param == 'amp'  ~  'Tail beat amplitude',
                           param == 'freq'  ~  'Tail beat frequency',
                           param == 'wavelength2'  ~  'Body wavelength',
                           param == 'wavespeed'  ~  'Body wave speed',
                           param == 'stridelength'  ~  'Stride length',
                           param == 'St'  ~  'Strouhal number',
                           param == 'traveling'  ~  'Traveling wave index',
                           param == 'curve'  ~  'Posterior body curvature',
                           TRUE  ~  param
                           )) %>%
  rename(F = Fstat,
         df1 = Fdf1,
         df2 = Fdf2,
         p = Fp,
         `10 - 1` = `eff_10 - 1`,
         p1 = `p.cont.signif_10 - 1`,
         `20 - 1` = `eff_20 - 1`,
         p2 = `p.cont.signif_20 - 1`) %>%
  # mutate(across(contains('- 1'), ~ round(.x, 2))) |> 
  # unite(`10 - 1`, `10 - 1`, p1, sep = '') |> 
  # unite(`20 - 1`, `20 - 1`, p2, sep = '') |> 
  gt(rowname_col = 'param') %>%
  tab_spanner(label = 'Effect sizes',
              columns = c(`10 - 1`, p1, `20 - 1`, p2)) %>%
  fmt_number('F', n_sigfig = 3) %>%
  fmt_number('p', decimals = 3) %>%
  fmt_number('df2', decimals = 1) %>%
  fmt_number(c(`10 - 1`, `20 - 1`),
             decimals = 2) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = abs(`10 - 1`) >= 0.8,
                           columns = `10 - 1`)
  ) %>%
  tab_style(
    style = cell_text(style = "italic"),
    locations = cells_body(rows = abs(`10 - 1`) >= 0.5 & abs(`10 - 1`) < 0.8,
                           columns = `10 - 1`)
  ) %>%
  tab_style(
    style = cell_text(weight = "lighter"),
    locations = cells_body(rows = abs(`10 - 1`) < 0.5,
                           columns = `10 - 1`)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = abs(`20 - 1`) >= 0.8,
                           columns = `20 - 1`)
  ) %>%
  tab_style(
    style = cell_text(style = "italic"),
    locations = cells_body(rows = abs(`20 - 1`) >= 0.5 & abs(`20 - 1`) < 0.8,
                           columns = `20 - 1`)
  ) %>%
  tab_style(
    style = cell_text(weight = "lighter"),
    locations = cells_body(rows = abs(`20 - 1`) < 0.5,
                           columns = `20 - 1`)
  )

statstable
```

```{r}
gtsave(statstable, 'statstable.tex')
```

## Generate the final plots

Add marginal means, standard errors, and statistical comparisons to the plots generated above.

```{r}
speed_plot_stat <-
  speed_plot +
  geom_pointrange(data = filter(kinematicsmodelmeans, param == 'speed.Ls'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmodelmeans, param == 'speed.Ls'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'speed.Ls'),
                     label = '{p.adj.signif}',
                     step.increase = 0.1,
                     y.position = 3.1)

speed_plot_stat
```

```{r}
amp_tail_plot_stat <-
  amp_tail_plot +
  geom_pointrange(data = filter(kinematicsmodelmeans, param == 'amp.L'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmodelmeans, param == 'amp.L'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'amp.L'),
                     hide.ns = TRUE,
                     label = '{p.adj.signif}',
                     x.position = 'viscosity',
                     step.increase = 0.1,
                     y.position = 0.2)

amp_tail_plot_stat
```

```{r}
freq_plot_stat <-
  freq_plot +
  geom_pointrange(data = filter(kinematicsmodelmeans, param == 'freq.hz'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmodelmeans, param == 'freq.hz'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'freq.hz'),
                     label = '{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 6,
                     hide.ns = TRUE)

freq_plot_stat
```




```{r}
wavelen_plot_stat <-
  wavelen_plot +
  geom_pointrange(data = filter(kinematicsmodelmeans, param == 'wavelength3.L'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmodelmeans, param == 'wavelength3.L'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'wavelength3.L'),
                     label = '{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 0.87,
                     step.increase = 0.1,
                     hide.ns = TRUE)

  #  annotate('text', x = 2, y = 0.9, label = 'ns')

wavelen_plot_stat
```

```{r}
curve_plot_stat <-
  curve_plot +
  geom_pointrange(data = filter(kinematicsmodelmeans, param == 'curve.post'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmodelmeans, param == 'curve.post'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'curve.post'),
                     label = '{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 6,
                     step.increase = 0.1,
                     hide.ns = TRUE)

  #  annotate('text', x = 2, y = 0.9, label = 'ns')

curve_plot_stat
```

## Put together the final kinematics figure

```{r}
speed_plot_stat + freq_plot_stat +
  plot_annotation(tag_levels = 'A')
```
```{r}
ggsave('kinematics_plot.pdf', width = 4.33, height = 2)
```

```{r}
amp_tail_plot_stat
```
```{r}
ggsave('amp_plot.pdf', width=3, height = 2)
```

```{r}
wavelen_plot_stat / curve_plot_stat +
  plot_annotation(tag_levels = 'A')
```

```{r}
ggsave('wavelen_plot.pdf', width=3, height = 4)
```


## Final nondimensional parameter figure

```{r}
stridelen_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = stridelength)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  labs(y = 'Stride length', x = 'Viscosity (cP)') +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line()) +
  geom_pointrange(data = filter(kinematicsmodelmeans, param == 'stridelength'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmodelmeans, param == 'stridelength'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'stridelength'),
                     label = '{p.adj.signif}',
                     x.position = 'viscosity',
                     step.increase = 0.1,
                     y.position = 0.75,
                     hide.ns = TRUE) +
  expand_limits(y = 0)
  

stridelen_plot
```

```{r}
slip_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = slip)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Slip', x = 'Viscosity (cP)') +
  geom_pointrange(data = filter(kinematicsmodelmeans, param == 'slip'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmodelmeans, param == 'slip'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'slip'),
                     label = '{p.adj.signif}',
                     x.position = 'viscosity',
                     step.increase = 0.1,
                     y.position = 0.85,
                     hide.ns = TRUE) +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())
  

slip_plot
```


```{r}
St_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = St)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'St', x = 'Viscosity (cP)') +
  geom_pointrange(data = filter(kinematicsmodelmeans, param == 'St'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmodelmeans, param == 'St'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  scale_y_continuous(breaks = c(0.3, 0.6, 0.9, 1.2)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'St'),
                     label = '{p.adj.signif}',
                     x.position = 'viscosity',
                     step.increase = 0.1,
                     y.position = 1.3,
                     hide.ns = TRUE) +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())
  

St_plot
```

```{r}
traveling_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = traveling)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Traveling wave index', x = 'Viscosity (cP)') +
  geom_pointrange(data = filter(kinematicsmodelmeans, param == 'traveling'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmodelmeans, param == 'traveling'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  scale_y_continuous(breaks = c(0.3, 0.6, 0.9, 1.2)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'traveling'),
                     label = '{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 0.95,
                     hide.ns = TRUE) +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())
  

traveling_plot
```

```{r}
stridelen_plot / St_plot / traveling_plot +
  plot_annotation(tag_levels = 'A')
```


```{r}
ggsave('efficiency_plot.pdf', width = 3, height = 6)
```

# Results section text with baseline stats

```{r}
totals <-
  kinematicsdata_all %>%
  group_by(viscosity.cP, indiv, trial) %>%
  summarize(dur = max(t) - min(t),
            nbeats = max(cycle, na.rm = TRUE)) %>%
  summarize(ntrials = n(),
            totaldur = sum(dur),
            totalbeats = sum(nbeats),
            avgdur = mean(dur),
            avgbeats = mean(nbeats)) %>%
  summarize(totaltrials = sum(ntrials),
            totaldur = sum(totaldur),
            totalbeats = sum(totalbeats),
            avgdur = mean(avgdur),
            avgbeats = mean(avgbeats))

totals <- 
  totals |> 
  bind_rows(totals |> 
              summarize(across(starts_with('total'), sum),
                        across(starts_with('avg'), mean))) |> 
  mutate(viscosity.cP = as.character(viscosity.cP),
         viscosity.cP = replace_na(viscosity.cP, 'total')) |> 
  column_to_rownames('viscosity.cP')

totals
```

```{r}
kinematicsdata_all %>%
  distinct(indiv, len.mm)
```

```{r}
lengths <-
  kinematicsdata_all |> 
  filter(bodyparts == '20') |>    # tail tip
  group_by(indiv) |> 
  summarize(len.mm = mean(s, na.rm = TRUE))

lengths
```

```{r}
kinematicsdata_all <-
  kinematicsdata_all |> 
  select(-len.mm) |> 
  left_join(lengths, by = 'indiv')
```

```{r}
meanlengths <-
  kinematicsdata_all %>%
  distinct(indiv, len.mm) %>%
  summarize(lenmn.mm = mean(len.mm),
            lensd.mm = sd(len.mm))
meanlengths
```

```{r}
kinematicsbasemeans <-
  kinematicsdata.bytrial |> 
  mutate(viscosity_num = as.numeric(as.character(viscosity.cP)),
         Re_body = rho * (speed.Ls*len.mm)/1000 * len.mm/1000 / (viscosity_num * 1e-3)) |> 
  group_by(viscosity.cP) |>
  mutate(amp.tail.L = abs(amp.tail.L),
         amp.L = abs(amp.L)) |> 
  summarize(across(c(speed.Ls, freq.hz, amp.tail.L, amp.L, wavelength3.L, curve.post,
                     St, slip, stridelength, Re_body, traveling),
                   list(mn = ~mean(.x, na.rm = TRUE),
                        sd = ~sd(.x, na.rm = TRUE)))) |>
  ungroup() |>
  mutate(viscosity.cP = as.character(viscosity.cP)) |>
  column_to_rownames('viscosity.cP')

kinematicsbasemeans
```

## Numbers for results

```{r}
totals['total','totaltrials']
meanlengths |> str_glue_data("{round(lenmn.mm)} +- {round(lensd.mm)}")

totals['total', 'totalbeats']
totals['1', 'totaltrials']
totals['10', 'totaltrials']
totals['20', 'totaltrials']
round(totals['1', 'avgbeats'])
round(totals['10', 'avgbeats'])
round(totals['20', 'avgbeats'])
```

```{r}
#We first extracted swimming kinematics using video analysis.
#Fig.\~\\ref{fig:midlines} shows example midlines at each of the three viscosities. One can see that the swimming speed and thus the stride length decreased substantially as viscosity increases. Fig.~\\ref{fig:kinematics} shows the average kinematic patterns for each individual as viscosity varies.
#Speed decreased from
kinematicsbasemeans['1',] |> 
  str_glue_data('{round(speed.Ls_mn, 1)} +- {round(speed.Ls_sd, 1)}') #{\\BLs} (mean \$\\pm\$ standard deviation) 

#to 
kinematicsbasemeans['20',] |> 
  str_glue_data('{round(speed.Ls_mn, 1)} +- {round(speed.Ls_sd, 1)}') # }{\\BLs} at the highest viscosity, 

# an effect size of 
effect_sizes |> 
  filter(param == 'speed.Ls', contrast == 'viscosity1 - viscosity20') |>
  str_glue_data('{round(-estimate, 2)}')
# (Fig.~\\ref{fig:kinematics}A), corresponding to a decrease from 
# $Re = \\num{
kinematicsbasemeans['1',] |> 
  str_glue_data('{signif(Re_body_mn, 1)} +- {signif(Re_body_sd, 1)}')
# to $\\num{
kinematicsbasemeans['20',] |> 
  str_glue_data('{signif(Re_body_mn, 1)} +- {signif(Re_body_sd, 1)}')
# (Fig.~\ref{fig:kinematics}B). 
# Frequency changed much less: from \\qty{
kinematicsbasemeans['1',] |> 
  str_glue_data('{round(freq.hz_mn, 1)} +- {round(freq.hz_sd, 1)}')
# {\Hz} in normal water to \\qty{
kinematicsbasemeans['20',] |> 
  str_glue_data('{round(freq.hz_mn, 1)} +- {round(freq.hz_sd, 1)}')
# {\\Hz} at the highest viscosity, with an effect size of 
effect_sizes |> 
  filter(param == 'freq.hz', contrast == 'viscosity1 - viscosity20') |>
  str_glue_data('{round(-estimate, 2)}')
# (Fig.~\ref{fig:kinematics}C). See Table~\\ref{tab:stats} for a statistical summary.
```

```{r}
# These changes seem to correspond to a decrease in the effectiveness of swimming at higher viscosity (Fig.~\ref{fig:efficiency}). The stride length, or the distance traveled in each tailbeat decreases from \qty{
kinematicsbasemeans['1', ] |> 
  str_glue_data('{round(stridelength_mn, 2)} +- {round(stridelength_sd, 2)}')
#{\BL} to \qty{
kinematicsbasemeans['20', ] |> 
  str_glue_data('{round(stridelength_mn, 2)} +- {round(stridelength_sd, 2)}')
# Strouhal number $St$ increases, from \num{
kinematicsbasemeans['1', ] |> 
  str_glue_data('{round(St_mn, 2)} +- {round(St_sd, 2)}')
# under control conditions to \num{
kinematicsbasemeans['20', ] |> 
  str_glue_data('{round(St_mn, 2)} +- {round(St_sd, 2)}')
# at the highest viscosity. 
```

```{r}
simkinematicsmeans <- 
  simkinematics.byvisc |> 
  column_to_rownames('viscosity')
```

```{r}
print('Although these kinematic parameters change, the overall body waveform is quite similar across viscosities. Fig.~\ref{fig:waveform}A shows the changes in the amplitude envelope as a function of position along the body. Amplitudes are slightly smaller along most of the body at the highest viscosity.  The average body amplitude (Fig.~\ref{fig:waveform}B) only drops significantly at the highest viscosity, by')
(kinematicsbasemeans['1','amp.L_mn'] - kinematicsbasemeans['10', 'amp.L_mn']) /
  kinematicsbasemeans['1','amp.L_mn'] * 100
(kinematicsbasemeans['1','amp.L_mn'] - kinematicsbasemeans['20', 'amp.L_mn']) /
  kinematicsbasemeans['1','amp.L_mn'] * 100
print('from ')
kinematicsbasemeans['1', ] |> 
  str_glue_data('{round(amp.L_mn, 3)} +- {round(amp.L_sd, 3)}')
print('under control conditions to')
kinematicsbasemeans['20', ] |> 
  str_glue_data('{round(amp.L_mn, 3)} +- {round(amp.L_sd, 3)}')
print('at 20cP, an effect size of ')
effect_sizes |> 
  filter(param == 'amp.L', contrast == 'viscosity1 - viscosity20') |>
  str_glue_data('{round(-estimate, 2)}')
print('respectively, and corresponding to tail tip amplitudes of')
kinematicsbasemeans['1', ] |> 
  str_glue_data('{round(amp.tail.L_mn, 3)} +- {round(amp.tail.L_sd, 3)}')
kinematicsbasemeans['10', ] |> 
  str_glue_data('{round(amp.tail.L_mn, 3)} +- {round(amp.tail.L_sd, 3)}')
kinematicsbasemeans['20', ] |> 
  str_glue_data('{round(amp.tail.L_mn, 3)} +- {round(amp.tail.L_sd, 3)}')
print('Under the same conditions, the simulation\'s body amplitude drops from')
sprintf('%.3f', simkinematicsmeans['1', 'amp.L'])
# at 1cP to
sprintf('%.3f', simkinematicsmeans['10', 'amp.L'])
# at 10cP
(simkinematicsmeans['1', 'amp.L'] - simkinematicsmeans['10', 'amp.L']) / 
  simkinematicsmeans['1', 'amp.L'] * 100
```

```{r}
print('The wavelength calculated from the first mode shortens only slightly at higher viscosity, decreasing by')
(kinematicsbasemeans['1','wavelength3.L_mn'] - kinematicsbasemeans['10', 'wavelength3.L_mn']) /
  kinematicsbasemeans['1','wavelength3.L_mn'] * 100
print('at 10cP, from')
kinematicsbasemeans['1',] |> 
  str_glue_data('{round(wavelength3.L_mn, 3)} +- {round(wavelength3.L_sd, 3)}')
# to
kinematicsbasemeans['10',] |> 
  str_glue_data('{round(wavelength3.L_mn, 3)} +- {round(wavelength3.L_sd, 3)}')
# at 10cP.
print('an effect size of ')
effect_sizes |> 
  filter(param == 'wavelength3.L', contrast == 'viscosity1 - viscosity10') |>
  str_glue_data('{round(-estimate, 2)}')
print('Even at 20cP, the wavelength is only ')
(kinematicsbasemeans['1','wavelength3.L_mn'] - kinematicsbasemeans['20', 'wavelength3.L_mn']) /
  kinematicsbasemeans['1','wavelength3.L_mn'] * 100
print('lower than under control conditions')
```

```{r}
print('This decrease depends substantially on individual variability, with 4 out of 5 individuals dropping less than 0.1L from control to the highest viscosity.')

kinematicsdata.bytrial |> 
  group_by(indiv, viscosity.cP) |> 
  summarize(wavelength3.L = mean(wavelength3.L, na.rm = TRUE)) |> 
  group_by(indiv) |> 
  arrange(viscosity.cP, .by_group = TRUE) |> 
  mutate(wavelendiff = wavelength3.L - wavelength3.L[1],
         small = wavelendiff < -0.05,
         big = wavelendiff < -0.1) |> 
  group_by(viscosity.cP) |> 
  summarize(nsmall = sum(small),
            nbig = sum(big))
```


```{r}
print('Curvature in the posterior body increased by')

(kinematicsbasemeans['10', 'curve.post_mn'] - kinematicsbasemeans['1', 'curve.post_mn']) / kinematicsbasemeans['1', 'curve.post_mn'] * 100

print('on average at 10cP, much less than the change in the simulation, which increased by')

(simkinematicsmeans['10', 'curve.post'] - simkinematicsmeans['1', 'curve.post']) / 
  simkinematicsmeans['1', 'curve.post'] * 100

```


```{r}
print("Again, the simulation's kinematics changed much more substantially over a smaller viscosity range, with the wavelength decreasing by ")
(simkinematicsmeans['1', 'wavelength.L'] - simkinematicsmeans['10', 'wavelength.L']) / 
  simkinematicsmeans['1', 'wavelength.L'] * 100
print("from")
simkinematicsmeans['1', 'wavelength.L']
simkinematicsmeans['10', 'wavelength.L']
```

```{r}
print('Our measured traveling index values of the first COM stay close to 1, regardless of viscosity, increasing slightly from ')
kinematicsbasemeans['1',] |> 
  str_glue_data('{round(traveling_mn, 2)} +- {round(traveling_sd, 2)}')
kinematicsbasemeans['20',] |> 
  str_glue_data('{round(traveling_mn, 2)} +- {round(traveling_sd, 2)}')

#\num{0.79 +- 0.05} under control conditions to \num{0.82 +- 0.06} at the highest viscosity.
```

```{r}
print('Speed dropped by ')
(kinematicsbasemeans['1', 'speed.Ls_mn'] - kinematicsbasemeans['20', 'speed.Ls_mn']) / 
  kinematicsbasemeans['1', 'speed.Ls_mn'] * 100

print('Frequency dropped by ')
(kinematicsbasemeans['1', 'freq.hz_mn'] - kinematicsbasemeans['20', 'freq.hz_mn']) / 
  kinematicsbasemeans['1', 'freq.hz_mn'] * 100

```
# Plots vs swimming speed

```{r}
kinematicsdata.speedlong <-
  kinematicsdata.bytrial |> 
  select(indiv, viscosity, trial, speed.Ls, amp.L, freq.hz, wavelength3.L,
         wavespeed.Ls, slip, stridelength, St, curve.post) |> 
  pivot_longer(cols = c(amp.L, freq.hz, wavelength3.L, wavespeed.Ls, slip,
                        stridelength, St, curve.post),
               names_to = "param")
  
```

```{r}
kinematicsdata.speedlong |> 
  ggplot(aes(x = speed.Ls, y = value, color = viscosity)) +
  geom_point() +
  facet_wrap(~ param, scale = "free")
```

```{r}
kinematicsspeedmodels <-
  kinematicsdata.speedlong %>%
  group_by(param) %>%
  nest() %>%
  mutate(model = purrr::map(data, ~ lmer(value ~ speed.Ls*viscosity + (1 | indiv),
                                         data = ., REML = TRUE, na.action = na.omit)),   # run the test
         summary = purrr::map(model, ~ summary(.)),
         slope = purrr::map_dbl(summary, ~ as.data.frame(.$coefficients)["speed.Ls", "Estimate"]),
         anova = purrr::map(model, ~ tidy(Anova(., test = 'F'))),   # get the fixed effect p value
         emtrends = purrr::map(model, ~ emtrends(., pairwise ~ viscosity, var = "speed.Ls")),
         pairs = purrr::map(emtrends, ~ tidy(.$contrasts)))
```

```{r}
#kinematicsspeedstats <-
  kinematicsspeedmodels %>%
  unnest(anova) %>%
  mutate(slope = if_else(term == "speed.Ls", slope, NA_real_)) |> 
  # select(-term) %>%
  rename(Fstat = statistic,
         Fdf1 = df,
         Fdf2 = Df.res,
         Fp = p.value) %>%
  select(-data, -model, -summary) |> 
  mutate(p.format = p_format(Fp, accuracy = 0.001)) |> 
  select(-emtrends, -pairs) |> 
  relocate(param, term, slope)

# kinematicsspeedstats

```

```{r}
emtrends(kinematicsspeedmodels$model[[1]], ~ viscosity, var = "speed.Ls")
```

```{r}
p1 <-
  kinematicsdata.bytrial |> 
  ggplot(aes(x = speed.Ls, y = freq.hz, color = viscosity, shape = viscosity)) +
  # geom_smooth(method = "lm") +
  # scale_color_brewer(direction = -1, palette = 7) +
  scale_color_grey(start = 0, end = 0.8) +
  scale_shape_manual(values = c(3, 1, 17)) +
  geom_point() +
  labs(y = 'Frequency (Hz)', x = "Speed (L s-1)") +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())

p2 <-
  kinematicsdata.bytrial |> 
  ggplot(aes(x = speed.Ls, y = wavespeed.Ls, color = viscosity, shape = viscosity)) +
  # geom_smooth(method = "lm") +
  # scale_color_brewer(direction = -1, palette = 7) +
  scale_color_grey(start = 0, end = 0.8) +
  scale_shape_manual(values = c(3, 1, 17)) +
  geom_point() +
  labs(y = 'Wave speed (L s-1)', x = "Speed (L s-1)") +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())

p3 <-
  kinematicsdata.bytrial |> 
  ggplot(aes(x = speed.Ls, y = stridelength, color = viscosity, shape = viscosity)) +
  # geom_smooth(method = "lm") +
  # scale_color_brewer(direction = -1, palette = 7) +
  scale_color_grey(start = 0, end = 0.8) +
  scale_shape_manual(values = c(3, 1, 17)) +
  geom_point() +
  labs(y = 'Stride length', x = "Speed (L s-1)") +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())
  
p4 <-
  kinematicsdata.bytrial |> 
  ggplot(aes(x = speed.Ls, y = wavelength.L, color = viscosity, shape = viscosity)) +
#  geom_smooth(method = "lm") +
  # scale_color_brewer(direction = -1, palette = 7) +
  scale_color_grey(start = 0, end = 0.8) +
  geom_point() +
  scale_shape_manual(values = c(3, 1, 17)) +
  labs(y = 'Wavelength (L)', x = "Speed (L s-1)") +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())

p1 + p2 + p3 + p4 + plot_layout(guides = 'collect') & plot_annotation(tag_levels = "A")

```

```{r}
ggsave('speedplots.pdf', width = 6.5, height = 4, units = "in")
```

# Citations

```{r}
citation()
sessionInfo()
```

```{r}
citation('lme4')
packageVersion('lme4')
```

```{r}
citation('emmeans')
packageVersion('emmeans')
```
```{r}
citation('lmerTest')
packageVersion('lmerTest')
```

