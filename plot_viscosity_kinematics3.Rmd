---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r setup}
library(tidyverse)
library(lubridate)
library(ggdist)
library(ggpubr)
library(rstatix)
library(performance)
library(lme4)
library(lmerTest)
library(report)
library(emmeans)
library(broom)
library(car)
library(patchwork)
library(here)
library(gt)
```

```{r}
source(here('process_midlines.R'))
source(here('hdf5dataset.R'))
```

# Load the data

Load in the processed kinematics data and update some of the variable names.  This includes frame-by-frame data for the entire body.

```{r}
kinematicsdata_all <- read_hdf5_old(here('midlines_all_kinematics.h5')) %>%
  mutate(date = as_date(date)) %>%
  mutate(wavespeed.mms = (snextseg - s)/(tpnextseg - tp)) %>%
  filter(!is.na(viscosity.cP)) %>%
  mutate(indiv = factor(indiv),
         viscosity.cP = factor(viscosity.cP),
         trial = interaction(indiv, trial, sep='-')) %>%
  rename(freq.hz = freq,
         wavelength.mm = wavelength,
         amp.mm = amp,
         speed.mms = swimvels)
```

## Baseline stats

```{r}
rho <- 1000   # kg/m^3
```

```{r}
totals <-
  kinematicsdata_all %>%
  group_by(viscosity.cP, indiv, trial) %>%
  summarize(dur = max(t) - min(t),
            nbeats = max(cycle, na.rm = TRUE)) %>%
  summarize(ntrials = n(),
            totaldur = sum(dur),
            totalbeats = sum(nbeats),
            avgdur = mean(dur),
            avgbeats = mean(nbeats)) %>%
  summarize(totaltrials = sum(ntrials),
            totaldur = sum(totaldur),
            totalbeats = sum(totalbeats),
            avgdur = mean(avgdur),
            avgbeats = mean(avgbeats))

totals
```

```{r}
kinematicsdata_all %>%
  distinct(indiv, len.mm)
```

```{r}
kinematicsdata_all %>%
  distinct(indiv, len.mm) %>%
  summarize(lenmn.mm = mean(len.mm),
            lensd.mm = sd(len.mm))

```

```{r}
totals %>%
  summarize(across(starts_with('total'), ~sum(.x)))
```

Now take means over half tailbeat cycles and over the body.
```{r}
kinematicsdata <-
  kinematicsdata_all %>%
  filter(!is.na(cycle)) %>%
  arrange(indiv, trial, frame, bodyparts) %>%
  mutate(amp.mm = abs(amp.mm)) %>%
  # take means across the body in each frame
  group_by(indiv, len.mm, trial, viscosity.cP, frame) %>%
  # ignore wavespeed estimates for the anterior body
  mutate(wavespeed.mms = if_else(bodyparts %in% c('15','16','17','18','19','20'), wavespeed.mms, NA_real_)) %>%
  summarize(across(c(speed.mms, freq.hz, wavespeed.mms, wavelength.mm), ~ mean(.x, na.rm = TRUE)),
         across(c(cycle, t), ~ last(na.omit(.x))),
         amp.tail.mm = last(na.omit(amp.mm)),
         amp.head.mm = first(na.omit(amp.mm))) %>%
  # then take means across each cycle
  group_by(indiv, len.mm, trial, viscosity.cP, cycle) %>%
  summarize(across(c(speed.mms, freq.hz, wavespeed.mms, wavelength.mm, amp.tail.mm, amp.head.mm), ~ mean(.x, na.rm = TRUE)),
            tcycle.s = first(na.omit(t))) %>%
  ungroup()
```

Normalize by length
```{r}
kinematicsdata <-
  kinematicsdata %>%
  mutate(speed.Ls = speed.mms / len.mm,
         amp.Ls = amp.tail.mm / len.mm,
         wavespeed.Ls = wavespeed.mms / len.mm,
         wavelength.L = wavelength.mm / len.mm,
         amp.head.L = amp.head.mm / len.mm,
         amp.tail.L = amp.tail.mm / len.mm)
```

Add nondimensional parameters
```{r}
kinematicsdata <-
  kinematicsdata %>%
  mutate(St = 2 * freq.hz * amp.tail.mm / speed.mms,
         stridelength = speed.Ls / freq.hz,
         slip = speed.Ls / wavespeed.Ls)
```

## Initial checks on the data

Plot all the swimming speeds, just to check.
```{r}
kinematicsdata %>%
  ggplot(aes(x = tcycle.s, y = speed.Ls, color = indiv, group = trial)) +
  geom_path() +
  facet_grid(viscosity.cP ~ ., scales = 'free')
```
### Swimming speed vs frequency

Should be nice and linear, but maybe a different slope with different viscosity.
```{r}
kinematicsdata %>%
  ggplot(aes(x = freq.hz, speed.Ls, color = indiv)) +
  geom_point() +
  facet_grid(viscosity.cP ~ ., scales = 'free') +
  xlim(c(0, 10))
```

### Stride length vs speed

Should not depend strongly on speed.
```{r}
kinematicsdata %>%
  ggplot(aes(x = speed.Ls, y = stridelength)) +
  geom_point(aes(color = indiv)) +
  facet_grid(viscosity.cP ~ indiv)
```
Looks like there may be some outlier data in one Lamprey 5 trial at 20cP

### Stride length and slip

Plot frequency vs speed, and the ratio, which is stride length. And wavespeed vs speed, and the ratio, which is slip. Both stride length and slip shouldn't depend too much on swimming speed.
```{r}
p1 <- kinematicsdata %>%
  filter(wavespeed.Ls > 0 & wavespeed.Ls < 7,
         freq.hz > 0 & freq.hz < 10) %>%
  ggplot(aes(x = speed.Ls, y = freq.hz, color = viscosity.cP)) +
  geom_point()

p2 <- kinematicsdata %>%
  filter(wavespeed.Ls > 0 & wavespeed.Ls < 7,
         freq.hz > 0 & freq.hz < 10) %>%
  ggplot(aes(x = speed.Ls, y = stridelength, color = viscosity.cP)) +
  geom_point()

p3 <- kinematicsdata %>%
  filter(wavespeed.Ls > 0 & wavespeed.Ls < 7,
         freq.hz > 0 & freq.hz < 10) %>%
  ggplot(aes(x = speed.Ls, y = wavespeed.Ls, color = viscosity.cP)) +
  geom_point()

p4 <- kinematicsdata %>%
  filter(wavespeed.Ls > 0 & wavespeed.Ls < 7,
         freq.hz > 0 & freq.hz < 10) %>%
  ggplot(aes(x = speed.Ls, y = slip, color = viscosity.cP)) +
  geom_point()

p1 + p2 + p3 + p4 + plot_layout(guides = 'collect')
```
## Filter out some outliers

```{r}
kinematicsdata %>%
  filter(indiv == '8' & speed.Ls > 4)
```

```{r}
kinematicsdata %>%
  filter(indiv == '5' & stridelength > 0.5 & viscosity.cP == 20)
```

```{r}
kinematicsdata %>%
  filter(stridelength > 1)
```

```{r}
outliertrials <- c('8-1', '5-2', '7-40', '8-42')
```

## Get means in each trial

```{r}
kinematicsdata.bytrial <-
  kinematicsdata %>%
  filter(!(trial %in% outliertrials),
         wavespeed.Ls > 0 & wavespeed.Ls < 7, 
         freq.hz > 0 & freq.hz < 10) %>%
  group_by(indiv, len.mm, viscosity.cP, trial) %>%
  summarize(across(c(speed.Ls, freq.hz, amp.head.L, amp.tail.L, wavelength.L, wavespeed.Ls, slip, stridelength, St),
                   ~ mean(., na.rm = TRUE)),
            dur.s = max(tcycle.s, na.rm = TRUE) - min(tcycle.s, na.rm = TRUE),
            nbeats = sum(!is.na(cycle))/2) %>%
  ungroup()

head(kinematicsdata.bytrial)
```

```{r}
write_hdf5(kinematicsdata.bytrial, 'kinematicsdatabytrial.h5')
```

### Add in Luna's wavelengths

```{r}
coddata <- read_csv('Data/coddata.csv') %>%
  mutate(indiv = factor(indiv),
         viscosity = factor(viscosity)) %>%
  select(-`...1`)
```
```{r}
coddata <- 
  coddata %>%
  filter(mode == 1 & point == 20) %>%
  select(indiv, trial, wavelength, traveling) %>%
  mutate(trial = paste(indiv, trial, sep='-')) %>%
  rename(wavelength2 = wavelength)
```

```{r}
kinematicsdata.bytrial <-
  left_join(kinematicsdata.bytrial, coddata,
          by = c("indiv", "trial")) %>%
  mutate(wavelength2.L = wavelength2/len.mm) %>%
  select(-wavelength2)
```

Update the viscosity measurement. 10cP was actually 6cP.
```{r}
kinematicsdata.bytrial <-
  kinematicsdata.bytrial %>%
  mutate(viscosity = fct_recode(viscosity.cP, '6' = '10'),
         viscosity.cP = case_when(viscosity == '1'  ~  1,
                                  viscosity == '6'  ~  6,
                                  viscosity == '20'  ~  20))
```

### Add in the tail velocity and additional amplitude calculation

```{r}
tailvelbycycle <- read_csv('tailveldata.csv')
head(tailvelbycycle)
```

```{r}
kinematicsdata.bytrial <-
  tailvelbycycle %>%
  mutate(trial = paste(indiv, trial, sep='-'),
         indiv = factor(indiv)) %>%
  group_by(indiv, trial) %>%
  summarize(across(c(amp.mm), ~ mean(., na.rm = TRUE))) %>%
  right_join(kinematicsdata.bytrial, by = c("indiv", "trial")) %>%
  mutate(amp.L = amp.mm / len.mm)

head(kinematicsdata.bytrial)
```

```{r}
kinematicsdata.bytrial %>%
  ggplot(aes(x = amp.tail.L, y = amp.L, color = viscosity.cP)) +
  geom_point() +
  geom_abline(slope = 1)
```

# Main kinematics plots

```{r}
binwidth <- 0.02
shapes <- c(15,16,17,25,23)
```

## Speed vs viscosity

```{r}
speed_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = speed.Ls)) +
  geom_dots(aes(color = indiv, shape = indiv, fill = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Speed (L/s)', x = 'Viscosity (cP)') +
  expand_limits(y = 0) +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())

speed_plot
```


## Tail amplitude vs viscosity

```{r}
amp_tail_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = amp.L)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Tail amplitude (L)', x = 'Viscosity (cP)') +
  theme_bw() +
  expand_limits(y = 0) +
  theme(panel.border = element_blank(), axis.line = element_line())

amp_tail_plot
```

### Head amplitude relative to the tail

This may not make it in to the paper as a main figure.
```{r}
rel_amp_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = amp.head.L / amp.tail.L)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Head amplitude relative to tail', x = 'Viscosity (cP)') +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())

rel_amp_plot
```
## Frequency vs viscosity

```{r}
freq_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = freq.hz)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Frequency (Hz)', x = 'Viscosity (cP)') +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())

freq_plot
```

## Wavelength vs viscosity

```{r}
wavelen_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = wavelength2.L)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Wavelength (L)', x = 'Viscosity (cP)') +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())

wavelen_plot
```

# Statistical tests

Rearrange the data table in an even longer format so that we can run all of the tests all at once.
```{r}
kinematicsdata.long <-
  kinematicsdata.bytrial %>%
  mutate(amp.rel = amp.head.L / amp.tail.L,
         Re_body = rho * speed.Ls * (len.mm/1000)^2 / (viscosity.cP * 1e-3)) %>%
  select(indiv, viscosity, trial, speed.Ls, amp.rel, amp.L, freq.hz, wavelength2.L, wavespeed.Ls, slip, stridelength, St, dur.s, nbeats, Re_body, traveling) %>%
  pivot_longer(cols = c(speed.Ls, amp.rel, amp.L, freq.hz, wavelength2.L, wavespeed.Ls, slip, stridelength, St, dur.s, nbeats, Re_body, traveling), names_to = "param")
```

Plot key parameters just to check.
```{r}
kinematicsdata.long %>%
  filter(param %in% c('speed.Ls', 'amp.L', 'freq.hz', 'wavelength2.L', 'wavespeed.Ls')) %>%
  ggplot(aes(x = viscosity, y = value)) +
  geom_dots(layout = 'swarm', side='both',
            binwidth = unit(0.02, 'npc')) +
  facet_wrap(~ param, scales = 'free')
```

And the nondimensional parameters
```{r}
kinematicsdata.long %>%
  filter(param %in% c('stridelength', 'slip', 'St',  'traveling')) %>%
  ggplot(aes(x = viscosity, y = value)) +
  geom_dots(layout = 'swarm', side='both') +
#            binwidth = unit(0.02, 'npc')) +
  facet_wrap(~ param, scales = 'free')
```

Get overall means and standard deviations
```{r}
kinematicsdata.long %>%
  group_by(param, viscosity) %>%
  summarize(mn = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))
```

```{r}
kinematicsdata.long %>%
  filter(param %in% c('wavelength2.L', 'amp.tail.L')) %>%
  group_by(param, indiv, viscosity) %>%
  summarize(mn = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE)) %>%
  mutate(d = mn - first(mn)) %>%
  arrange(param, viscosity, indiv)
```

## Build the models

Make a nested data frame and run `lmer` to estimate a mixed model with viscosity as a fixed factor and individual as a random factor.

Note that I tried running a model with individual responses to viscosity as a random effect also (`value ~ viscosity + (1 + viscosity | indiv)`), but it was singular.
```{r}
kinematicsmodels <-
  kinematicsdata.long %>%
  group_by(param) %>%
  nest() %>%
  mutate(model = purrr::map(data, ~ lmer(value ~ viscosity + (1 | indiv),
                                         data = ., REML = TRUE, na.action = na.omit)),   # run the test
         anova = purrr::map(model, ~ tidy(Anova(., test = 'F'))),   # get the fixed effect p value
         pairs = purrr::map(model, ~ tidy(pairs(emmeans(., specs = ~viscosity)))))   # and the pairwise comparisons
```

Then unnest the data frame and pull out the overall significance and the p values for comparing each case to the control (viscosity = 1cP).
```{r}
kinematicsstats <-
  kinematicsmodels %>%
  unnest(anova) %>%
  select(-term) %>%
  rename(Fstat = statistic,
         Fdf1 = df,
         Fdf2 = Df.res,
         Fp = p.value) %>%
  select(-data, -model) %>%
  unnest(pairs) %>%
  separate(contrast, into = c("group1", "group2")) %>%
  mutate(p.format = p_format(adj.p.value, accuracy = 0.001)) %>%
  rename(p.adj = adj.p.value) %>%
  filter(group1 == 1) %>%
  # mutate(group1 = 'all') %>%
  add_significance('p.adj')
  #select(-term, -null.value, -estimate, -std.error, -df, -statistic) %>%
  #pivot_wider(names_from = contrast, values_from = adj.p.value)

kinematicsstats
```



Also add in the group-wise marginal means.
```{r}
kinematicsmeans <-
  kinematicsmodels %>%
  mutate(means = purrr::map(model, ~ tidy(emmeans(., specs = ~viscosity)))) %>%
         #effs = purrr::map(model, ~ tidy(eff_size(., specs)))) %>%
  select(param, means) %>%
  unnest(means)

kinematicsmeans
```

```{r}
effect_sizes <-
  kinematicsmodels %>%
  mutate(effs = purrr::map(model, 
                           ~tidy(eff_size(emmeans(., specs = ~viscosity),
                                          sigma = sigma(.),
                                          edf = df.residual(.))))) %>%
  select(param, effs) %>%
  unnest(effs)
```

```{r}
statstable <-
  kinematicsstats %>%
  select(param, Fstat, Fdf1, Fdf2, Fp) %>%
  ungroup() %>%
  distinct(param, .keep_all = TRUE) %>%
  right_join(effect_sizes, by = 'param') %>%
  select(-c(term, null.value, std.error, df, statistic, p.value)) %>%
  filter(contrast != '6 - 20') %>%
  mutate(estimate = -estimate,
         contrast = case_when(contrast == '1 - 6'  ~  '6 - 1',
                              contrast == '1 - 20'  ~  '20 - 1')) %>%
  pivot_wider(names_from = contrast, values_from = estimate) %>%
  filter(param %in% c('speed.Ls',
                      'amp.L',
                      'freq.hz',
                      'wavelength2.L',
                      'wavespeed.Ls',
                      'stridelength',
                      'St',
                      'traveling')) %>%
  separate(param, into = c('param'), sep = '\\.', extra = 'drop') %>%
  mutate(param = case_when(param == 'speed'  ~   'Swimming speed',
                           param == 'amp'  ~  'Tail beat amplitude',
                           param == 'freq'  ~  'Tail beat frequency',
                           param == 'wavelength2'  ~  'Body wavelength',
                           param == 'wavespeed'  ~  'Body wave speed',
                           param == 'stridelength'  ~  'Stride length',
                           param == 'St'  ~  'Strouhal number',
                           param == 'traveling'  ~  'Traveling wave index',
                           TRUE  ~  param
                           )) %>%
  rename(F = Fstat,
         df1 = Fdf1,
         df2 = Fdf2,
         p = Fp) %>%
  gt(rowname_col = 'param') %>%
  tab_spanner(label = 'Effect sizes',
              columns = c(`6 - 1`, `20 - 1`)) %>%
  fmt_number('F', n_sigfig = 3) %>%
  fmt_number('p', decimals = 3) %>%
  fmt_number(c(`6 - 1`, `20 - 1`),
             decimals = 2) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = abs(`6 - 1`) >= 0.8,
                           columns = `6 - 1`)
  ) %>%
  tab_style(
    style = cell_text(style = "italic"),
    locations = cells_body(rows = abs(`6 - 1`) >= 0.5 & abs(`6 - 1`) < 0.8,
                           columns = `6 - 1`)
  ) %>%
  tab_style(
    style = cell_text(weight = "lighter"),
    locations = cells_body(rows = abs(`6 - 1`) < 0.5,
                           columns = `6 - 1`)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = abs(`20 - 1`) >= 0.8,
                           columns = `20 - 1`)
  ) %>%
  tab_style(
    style = cell_text(style = "italic"),
    locations = cells_body(rows = abs(`20 - 1`) >= 0.5 & abs(`20 - 1`) < 0.8,
                           columns = `20 - 1`)
  ) %>%
  tab_style(
    style = cell_text(weight = "lighter"),
    locations = cells_body(rows = abs(`20 - 1`) < 0.5,
                           columns = `20 - 1`)
  )

statstable
```

```{r}
gtsave(statstable, 'statstable.tex')
```

## Generate the final plots

Add marginal means, standard errors, and statistical comparisons to the plots generated above.

```{r}
speed_plot_stat <-
  speed_plot +
  geom_pointrange(data = filter(kinematicsmeans, param == 'speed.Ls'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmeans, param == 'speed.Ls'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'speed.Ls'),
                     label = '{p.format}{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 4.1)

speed_plot_stat
```

```{r}
amp_tail_plot_stat <-
  amp_tail_plot +
  geom_pointrange(data = filter(kinematicsmeans, param == 'amp.L'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmeans, param == 'amp.L'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'amp.L'),
                     label = '{p.format}{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 0.18)

amp_tail_plot_stat
```

```{r}
freq_plot_stat <-
  freq_plot +
  geom_pointrange(data = filter(kinematicsmeans, param == 'freq.hz'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmeans, param == 'freq.hz'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'freq.hz'),
                     label = '{p.format}{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 6,
                     hide.ns = TRUE)

freq_plot_stat
```




```{r}
wavelen_plot_stat <-
  wavelen_plot +
  geom_pointrange(data = filter(kinematicsmeans, param == 'wavelength2.L'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmeans, param == 'wavelength2.L'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'wavelength2.L'),
                     label = '{p.format}{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 0.9,
                     hide.ns = TRUE)

  #  annotate('text', x = 2, y = 0.9, label = 'ns')

wavelen_plot_stat
```
## Put together the final kinematics figure

```{r}
speed_plot_stat + freq_plot_stat +
  plot_annotation(tag_levels = 'A')
```
```{r}
ggsave('kinematics_plot.pdf', width = 4.33, height = 2)
```

```{r}
amp_tail_plot_stat
```
```{r}
ggsave('amp_plot.pdf', width=3, height = 2)
```

```{r}
wavelen_plot_stat
```

```{r}
ggsave('wavelen_plot.pdf', width=3, height = 2)
```

```{r}
cfddata <- read_csv(here('cfdviscositykinematics.csv'))
```
```{r}
cfddata
```


```{r}
kinematicsmeans %>%
  mutate(viscosity.cP = as.numeric(as.character(viscosity))) %>%
  filter(param == 'wavelength2.L') %>%
  ggplot(aes(x = viscosity.cP, y = estimate)) +
  geom_pointrange(aes(ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(aes(group = 1)) +
  geom_point(data = cfddata, aes(x = viscosity, y = wavelen / bodylen), color = 'red',
             inherit.aes = FALSE) +
  geom_line(data = cfddata, aes(x = viscosity, y = wavelen / bodylen), color = 'red',
             inherit.aes = FALSE)
```

## Final nondimensional parameter figure

```{r}
stridelen_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = stridelength)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  labs(y = 'Stride length', x = 'Viscosity (cP)') +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line()) +
  geom_pointrange(data = filter(kinematicsmeans, param == 'stridelength'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmeans, param == 'stridelength'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'stridelength'),
                     label = '{p.format}{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 0.85,
                     hide.ns = TRUE) +
  expand_limits(y = 0)
  

stridelen_plot
```

```{r}
slip_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = slip)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Slip', x = 'Viscosity (cP)') +
  geom_pointrange(data = filter(kinematicsmeans, param == 'slip'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmeans, param == 'slip'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'slip'),
                     label = '{p.format}{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 0.85,
                     hide.ns = TRUE) +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())
  

slip_plot
```


```{r}
St_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = St)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'St', x = 'Viscosity (cP)') +
  geom_pointrange(data = filter(kinematicsmeans, param == 'St'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmeans, param == 'St'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  scale_y_continuous(breaks = c(0.3, 0.6, 0.9, 1.2)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'St'),
                     label = '{p.format}{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 1.3,
                     hide.ns = TRUE) +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())
  

St_plot
```

```{r}
traveling_plot <-
  kinematicsdata.bytrial %>%
  ggplot(aes(x = viscosity, y = traveling)) +
  geom_dots(aes(color = indiv, shape = indiv),
            group = NA,
            position = 'dodge',
            width = 0.6,
            side = 'both',
            binwidth = unit(binwidth, 'npc'),
            layout = 'swarm',
            show.legend = FALSE) +
  scale_shape_manual(values = shapes) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  labs(y = 'Traveling wave index', x = 'Viscosity (cP)') +
  geom_pointrange(data = filter(kinematicsmeans, param == 'traveling'),
                  aes(x = viscosity, y = estimate, ymin = estimate - std.error, ymax = estimate + std.error),
                  shape = 4, size = 0.5) +
  geom_line(data = filter(kinematicsmeans, param == 'traveling'),
                  aes(x = viscosity, y = estimate, group = 1)) +
  scale_y_continuous(breaks = c(0.3, 0.6, 0.9, 1.2)) +
  stat_pvalue_manual(data = filter(kinematicsstats, param == 'traveling'),
                     label = '{p.format}{p.adj.signif}',
                     x.position = 'viscosity',
                     y.position = 0.95,
                     hide.ns = TRUE) +
  theme_bw() +
  theme(panel.border = element_blank(), axis.line = element_line())
  

traveling_plot
```

```{r}
stridelen_plot / St_plot / traveling_plot +
  plot_annotation(tag_levels = 'A')
```


```{r}
ggsave('efficiency_plot.pdf', width = 3, height = 6)
```

# Citations

```{r}
citation()
sessionInfo()
```

```{r}
citation('lme4')
packageVersion('lme4')
```

```{r}
citation('emmeans')
packageVersion('emmeans')
```
```{r}
citation('lmerTest')
packageVersion('lmerTest')
```

